#! /bin/sh

# helps bootstrapping M4, when checked out from CVS
# requires GNU Autoconf, GNU Automake, GNU Gettext and GNU Libtool

: ${AWK="awk"}
: ${SED="sed"}
: ${RM="rm -f"}
: ${GNULIB_TOOL="gnulib-tool"}

ltdldir=ltdl
config_aux_dir=$ltdldir/config
config_macro_dir=$ltdldir/m4

src_modules='getopt version-etc'

dirname="s,/[^/]*$,,"
basename="s,^.*/,,g"

# Work around backward compatibility issue on IRIX 6.5. On IRIX 6.4+, sh
# is ksh but when the shell is invoked as "sh" and the current value of
# the _XPG environment variable is not equal to 1 (one), the special
# positional parameter $0, within a function call, is the name of the
# function.
progpath="$0"

# The name of this program:
progname=`echo "$progpath" | $SED "$basename"`

# func_echo arg...
# Echo program name prefixed message.
func_echo ()
{
    echo $progname: ${1+"$@"}
}

func_echo "running: ${GNULIB_TOOL} --import"
${GNULIB_TOOL} --import

func_echo "patching include directories in gnulib regex module"
mv $config_macro_dir/regex.m4 $config_macro_dir/regex-m4.old
sed 's,lib/regex.c,gnu/regex.c,g' $config_macro_dir/regex-m4.old > $config_macro_dir/regex.m4 && \
  $RM $config_macro_dir/regex-m4.old

func_echo "hiding gnulib jm_\* macros"
cat >> $config_macro_dir/gnulib.m4 <<\EOF
AC_DEFUN([gl_AC_HEADER_INTTYPES_H], [jm_AC_HEADER_INTTYPES_H])
AC_DEFUN([gl_AC_HEADER_STDINT_H], [jm_AC_HEADER_STDINT_H])
AC_DEFUN([gl_AC_TYPE_UINTMAX_T], [jm_AC_TYPE_UINTMAX_T])
EOF

func_echo "fetching version_etc and getopt modules for src directory"
gnulibdir=`which gnulib-tool | $SED "$dirname"`
for file in `${GNULIB_TOOL} --extract-filelist $src_modules`; do

    dest=`echo $file | $SED "$basename"`
    case $file in
        lib/*) dest=src/$dest ;;
	m4/*)  dest=$config_macro_dir/$dest ;;
	*)     func_echo "Unknown file: $file"
	       exit 1
	       ;;
    esac

    func_echo "copying file \`$dest'"
    cp $gnulibdir/$file $dest
done

func_echo "running: libtoolize --ltdl=\"$ltdldir\" --force --copy"
libtoolize --ltdl="$ltdldir" --force --copy

func_echo "running: autoreconf --force --verbose --install"
autoreconf --force --verbose --install

(
  func_echo "generating testsuite"
  cd tests
  $AWK -f ./generate.awk ../doc/m4.texinfo > generated.at
)

exit 0
