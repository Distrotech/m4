#!/bin/sh

# shadow.test is part of the GNU m4 testsuite

. ${srcdir}/defs
. ${builddir}/../tests/config.sh

# cannot perform test without --with-modules
test -z "$WITH_MODULES" && exit 77

cat <<'EOF' >in
test
__test__
load(`modtest')
test
__test__
load(`shadow')
test
__test__
unload(`modtest')
test
__test__
load(`modtest')
test
__test__
unload(`modtest')
test
__test__
unload(`shadow')
test
__test__
EOF

cat <<'EOF' >ok
test
__test__
Test module loaded.
Test module called.
modtest
Shadow module loaded.
Shadow::test called.
shadow

Shadow::test called.
shadow
Test module loaded.
Test module called.
modtest

Shadow::test called.
shadow

test
__test__
EOF

cat <<'EOF' >okerr
EOF


M4PATH=$srcdir:$srcdir/../tests $M4 -M `cd $builddir; pwd` -d in >out 2>err
sed -e "s,^[^:]*[lt-]*m4[.ex]*:,m4:," err >sederr && mv sederr err
$CMP -s out ok && $CMP -s err okerr
